#!/usr/bin/perl

use Genome;
use Revision;
use Library;
use Users;
use JenkinsData;

use strict;
use warnings;


# flush output buffer after every write or print
local $| = 1;
Library::setup_model_process_test();


Library::set_genome_software_result_test_name();

if (Genome::Sys->username eq 'apipe-tester' && !$ENV{MODEL_TEST_TO}) {
    $ENV{MODEL_TEST_TO} = Library::users_to_addresses(Users->cle);
}

my $cmd0 = Genome::Config::AnalysisProject::Command::Create->create(
    environment => "ad-hoc",
    name => "CLE Test",
    no_config => 1
);
my $analysis_project = $cmd0->execute;
my %tag_to_menu_item = (
    discovery => "9ab6e28f832a428393b87b171d444401",
    followup => "9ab6e28f832a428393b87b171d444401",
    germline => "3770b8510d5a459f9c0bb01fabf56337",
);
while (my ($tag_name, $menu_item_id) = each %tag_to_menu_item) {
    my $menu_item = Genome::Config::AnalysisMenu::Item->get($menu_item_id);
    my $tag = Genome::Config::Tag->get(name => $tag_name);
    Genome::Config::AnalysisProject::Command::AddMenuItem->execute(
        analysis_menu_items => $menu_item,
        tags => $tag,
        analysis_project => $analysis_project,
    );
}

my $subject_mapping_file = Genome::Sys->create_temp_file_path;
my $subject_mapping = <<'SUBJECT_MAPPINGS';
H_KA-174556-1309237	H_KA-174556-1309246				followup
H_KA-174556-1309245	H_KA-174556-1309246				discovery
H_KA-174556-1309246					germline
SUBJECT_MAPPINGS

Genome::Sys->write_file($subject_mapping_file, $subject_mapping);
Genome::Config::AnalysisProject::SubjectMapping::Command::Import::SomaticValidation->execute(
    analysis_project => $analysis_project,
    file_path => $subject_mapping_file,
);

my @instrument_data = qw(2893814999 2893815000 2893815001 2893815002 2893815003 2893815016 2893815018 2893815020 2893815023 2893815024 2893815447 2893815448 2893815449 2893815451 2893815484 2893815485 2893815489 2893815492);
for my $id (@instrument_data) {
    my $instrument_data = Genome::InstrumentData->get($id);
    Genome::Config::AnalysisProject::InstrumentDataBridge->create(
        analysis_project => $analysis_project,
        instrument_data => $instrument_data,
        status => 'new',
    );
}

Genome::Config::AnalysisProject::Command::Release->execute(
    analysis_projects => [$analysis_project],
);

my @instrument_data_objects = Genome::InstrumentData->get(id => \@instrument_data);
Genome::Config::Command::ConfigureQueuedInstrumentData->execute(
    instrument_data => \@instrument_data_objects,
);

my @models = Genome::Model->get(analysis_project => $analysis_project);
Genome::Model::Build::Command::Start->execute(
    models => \@models,
);
UR::Context->commit;
my @builds = Genome::Model::Build->get(model_id => [map {$_->id} @models]);

my $start_time = time;
my @diff_cmds;

my $timeout = Library::get_timeout_seconds(24);
for my $build (@builds) {
    Library::wait_for_build($build, $start_time, $timeout);
    UR::Context->current->reload($build);
    Library::check_build_failure($build);
    my $diff_cmd = diff_build($build);
    if (defined $diff_cmd) {
        push @diff_cmds, $diff_cmd;
    }
}

my $discovery_subject = get_sample_from_subject_mapping($analysis_project, $discovery_tag);
my $followup_subject = get_sample_from_subject_mapping($analysis_project, $followup_tag);
my $germline_subject = get_sample_from_subject_mapping($analysis_project, $germline_tag);

my @models_for_process = Genome::Model::SomaticValidation->get(analysis_project => $analysis_project,
    region_of_interest_set_name => 'SeqCap EZ Human Exome v3.0 + AML RMG pooled probes + WO2830729 pooled probes + WO2840081 pooled probes');
my @coverage_models_for_process = Genome::Model::SomaticValidation->get(analysis_project => $analysis_project,
    tumor_sample => [$discovery_subject, $followup_subject]);
my @germline_models = grep {$_->tumor_sample eq $germline_subject} @models_for_process;
Genome::VariantReporting::Command::Wrappers::Trio->execute(
    models => \@models_for_process,
    coverage_models => \@coverage_models_for_process,
    tumor_sample => $discovery_subject,
    followup_sample => $followup_subject,
    normal_sample => $germline_subject,
);
UR::Context->commit;

Library::wait_for_process($process, $timeout);

UR::Context->current->reload($process);

Library::check_process_failure($process);

my $process_diff_cmd = diff_process($process);
if ($process_diff_cmd) {
    push @diff_cmds, $process_diff_cmd;
}
if (@diff_cmds) {
    Library::send_diff_mail(@diff_cmds);
    exit(255);
}
# functions
sub get_sample_from_subject_mapping {
    my ($anp, $tag) = @_;
    my $mapping = Genome::Config::AnalysisProject::SubjectMapping->get(analysis_project => $anp,
        tags => [$tag]);
    my ($bridge) = $mapping->subject_bridges(label => 'tumor_sample');
    return $bridge->subject;
}

sub diff_build {
    my $build = shift;

    printf("Starting diff (new build = %s)...\n", $build->id);

    my @blessed_builds = Genome::Model::Build->get(id => [qw(
    185d8bac3d7c4437b7ce9207dfadac7e
    5f57f08a8fd84886b275f0b5571e9fd7
    e02e8a5ccaad458d839de51eb47d8d2c
    26e65adaa8034dd99ef92b27f61ad862
    3243f261a8b64c089a5254291f7c2de3
    f87701c292e843958d088e171a65a67a
    301d5d51c96e41308d015008720f3962
    )]);

    my $matching_blessed_build;
    for my $blessed_build (@blessed_builds) {
        if ($build->tumor_sample eq $blessed_build->tumor_sample and
                ((!defined($build->normal_sample) and !defined($blessed_build->normal_sample)) or
                    ($build->normal_sample eq $blessed_build->normal_sample)) and
            $build->target_region_set_name eq $blessed_build->target_region_set_name) {
                $matching_blessed_build = $blessed_build;
                last;
            }
    }
    unless (defined $matching_blessed_build) {
        fail(sprintf("No matching blessed build found for build %s\n", $build->id));
    }

    my $diff_cmd = Genome::Model::Build::Command::Diff->create(
        new_build => $build,
        blessed_build => $matching_blessed_build,
    );
    unless ($diff_cmd->execute) {
        fail(sprintf("Diff command failed to execute for build %s!\n", $build->id));
    }

    if ($diff_cmd->has_diffs()) {
        return $diff_cmd;
    }
    return;
}

sub diff_process {
    my $process = shift;

    my $blessed_process = Genome::Process->get("2b2b3d8481284fcf8a1632d65ba58083");

    printf("Starting diff (new process = %s)...\n", $process->id);
    my $diff_cmd = Genome::Process::Command::Diff->create(
        new_process => $process,
        blessed_process => $blessed_process,
    );
    unless ($diff_cmd->execute) {
        fail("Diff command failed to execute!\n");
    }

    if ($diff_cmd->has_diffs()) {
        return $diff_cmd;
    }
    return;
}

sub fail {
    Library::fail("cle test", @_);
}

