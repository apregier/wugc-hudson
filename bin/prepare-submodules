#!/bin/bash

set -o errexit

__quiet_git() {
    (
        set +o errexit
        OUT=$(git "$@" 2>&1)
        GIT_EXIT=$?
        if test $GIT_EXIT -ne 0
        then
            echo $OUT 1>&2
            exit $GIT_EXIT
        fi
    )
}

echo -e "\n=> Preparing Submodules..." 1>&2

__quiet_git submodule sync

for submodule in $@; do
    echo -n "   $submodule..." 1>&2
    set +o errexit
    __quiet_git submodule update --init $submodule
    cd $submodule

    if [ "$(git rev-parse --abbrev-ref HEAD)" != "HEAD" ]; then
        STASH_COUNT=$(git stash list | wc -l)
        git stash save --include-untracked --quiet
        NEW_STASH_COUNT=$(git stash list | wc -l)
        if [ $NEW_STASH_COUNT -gt $STASH_COUNT ]; then
            echo -n ' stashed changes...' 1>&2
        fi
    fi

    git reset --hard HEAD > /dev/null
    git clean -d --force > /dev/null
    cd - > /dev/null
    echo ' done' 1>&2
done
