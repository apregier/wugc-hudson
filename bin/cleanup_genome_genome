#!/bin/bash

set -o errexit

BUILD_BASEDIR="/gscmnt/gc13001/info/model_data/apipe-ci/workspace/genome_genome"
JOB_URL="http://apipe-ci.gsc.wustl.edu/view/GitHub/job/genome_genome"

cd "$BUILD_BASEDIR"

if test -z "$1"
then
    find * -maxdepth 0 -exec "${BASH_SOURCE[0]}" "{}" \;
    exit
else
    set -o nounset

    BUILD_NUMBER="$1"

    if ! echo "$BUILD_NUMBER" | grep -qP '^[0-9]*$'
    then
        echo "ERROR: BUILD_NUMBER is not a number: $BUILD_NUMBER" 1>&2
        exit 128
    fi

    if ! test -d "$BUILD_NUMBER"
    then
        echo "ERROR: build directory not found: $BUILD_NUMBER" 1>&2
        exit 128
    fi

    if ! curl --fail --silent --head "$JOB_URL/api/xml" > /dev/null
    then
        echo "ERROR: failed to verify job URL" 1>&2
        exit 128
    fi

    if curl --fail --silent --head "$JOB_URL/$BUILD_NUMBER/api/xml?xpath=/*/building" > /dev/null
    then
        echo "Keeping $BUILD_NUMBER."
    else
        echo "Deleting $BUILD_NUMBER..."
        rm -rf "$BUILD_NUMBER"
    fi
    exit
fi
