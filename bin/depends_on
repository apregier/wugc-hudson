#!/usr/bin/env perl
use strict;
use warnings;

my $unstable_builds = 0;
for my $job (@ARGV) {
    print "Checking " . $job . "... ";
    my $last_build_number = get_build_number($job, 'lastBuild') || die;
    my $stable_build_number = get_build_number($job, 'lastStableBuild') || die;
    if ($last_build_number && $stable_build_number && $last_build_number eq $stable_build_number && $last_build_number > 0) {
        print "stable.\n";
    } else {
        print "unstable.\n";
        $unstable_builds++;
    }
}
exit $unstable_builds;

sub get_build_number {
    my $job = shift;
    my $type = shift;

    my $build_xml = qx(wget -q -O - http://apipe-ci.gsc.wustl.edu/job/$job/api/xml?xpath=/*/$type/number);
    $build_xml =~ />(\d+)</;
    my $build_number = $1;

    return $build_number;
}
