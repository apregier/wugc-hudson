#!/usr/bin/env perl

use strict;
use warnings;

BEGIN {
	require Cwd;
	require File::Basename;
	my $lib_dir = Cwd::abs_path(File::Basename::dirname(__FILE__) . '/../lib/');
	unless (grep { $lib_dir eq Cwd::abs_path($_) } @INC) {
		push @INC, $lib_dir;
	}
}

require Defaults;
require Snapshot;


my $build_number = shift @ARGV;

my $workspace_base = Defaults::HUDSON_CUSTOM_WORKSPACE() || die;

my @source_dirs = (
    "$workspace_base/ur",
    "$workspace_base/workflow",
    "$workspace_base/genome",
);

print "Tagging Genome with genome-$build_number\n";
system("cd $workspace_base/genome && " . Defaults::GIT_BIN() . " tag genome-$build_number && " . Defaults::GIT_BIN() . " push origin refs/tags/genome-$build_number") && die;
my $git_repo = Defaults::GIT_REPOS_BASE() . '/genome/lib/perl';
system("cd $git_repo && git reset --hard HEAD && git pull");

print "Creating Snapshot\n";
my $snapshot = Snapshot->create(
    snapshot_dir => Defaults::TESTED_PATH() . "/genome-$build_number",
    source_dirs => \@source_dirs,
);

